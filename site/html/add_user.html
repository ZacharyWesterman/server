<!DOCTYPE html>
<html lang="en">
<head>
	<title>test html</title>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<meta name="description" content="boilerplate html" />
	<script type="text/javascript" src="js/fields.js"></script>
	<script type="text/javascript" src="js/doT.js"></script>

	<link rel="stylesheet" href="css/theme.css">
	<link rel="stylesheet" href="css/main.css">

	<script name="userlist" type="text/x-dot-template" src="templates/userlist.dot"></script>
</head>
<body>
	<p>
		<h1>Existing Users:</h1>
		<div name="userlist"></div>

		<h1>Create New User</h1>
		<input id="username" placeholder="Username" />
		<input id="password" type="password" placeholder="Password" />
		<button type="button" onclick="create_user()">Submit</button>
	</p>
	<button onclick="logout()">Logout</button>
</body>
<script type="text/javascript">
	_('userlist', api('{listUsers}')) //initial load of user list

	async function delete_user(username)
	{
		const query = `
		mutation ($username: String!){
			deleteUser(username: $username) {
				__typename
				...on BadUserNameError {
					message
				}
			}
		}`
		const vars = {
			'username' : username,
		}

		var res = await api(query, vars)
		if (res.__typename !== 'UserData') {
			alert('ERROR: ' + res.message)
		}

		_('userlist', api('{listUsers}')) //refresh user list
	}

	async function create_user()
	{
		const query = `
		mutation ($username: String!, $password: String!){
			createUser(username: $username, password: $password) {
				__typename
				...on BadUserNameError {
					message
				}
			}
		}`
		const vars = {
			'username' : $.val('username'),
			'password' : await api.hash($.val('password')),
		}

		var res = await api(query, vars)
		if (res.__typename !== 'UserData') {
			alert('ERROR: ' + res.message)
		}

		_('userlist', api('{listUsers}')) //refresh user list
	}

	async function logout()
	{
		api.login_token = null
		api.write_cookies()
		window.location.href = '/'
	}

</script>
</html>
