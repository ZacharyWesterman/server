<div class="page">
	<h1>
		<i class="fa-solid fa-gear fa-xl"></i>
		Server Settings
	</h1>

	<div class="card">
		<div class="card-inner">
			<h2 style="text-align: center;">Modules</h2>
			<hr>
			<div id="server_modules"></div>
		</div>
	</div>

	<div class="card">
		<div class="card-inner">
			<h2 style="text-align: center;">Configuration</h2>
			<hr>
			<div id="server_configs"></div>
		</div>
	</div>
</div>

<script>
	export async function init()
	{
		let cfg = api.get_json('/config/configs.json')
		let s_cfg = api('{getConfigs { name value } }')

		let modl = api.get_json('/config/modules.json')
		let promise = _('server_modules', modl)
		const modules = await api('{getEnabledModules}')
		await promise

		//Lock modules if they have a required module which is not enabled.
		for (const m of await modl)
		{
			if (m.requires?.length)
			{
				for (const i of m.requires)
				{
					const parent_field = $(`module-${i}`)
					const prev_onclick = parent_field.onclick || (() => {})
					parent_field.onclick = () =>
					{
						prev_onclick()

						let disabled = false
						for (const x of m.requires)
						{
							if (!$(`module-${x}`).checked)
							{
								disabled = true
								break
							}
						}

						const this_field = $(`module-${m.id}`)
						if (disabled && this_field.checked)
						{
							set_module_enabled(m.id, !disabled)
						}
						this_field.disabled = disabled
					}
				}
			}
		}

		for (const m of modules)
		{
			$(`module-${m}`).checked = true
		}

		//Build configs list
		const set_configs = await s_cfg
		let configs = (await cfg).map(c => {
			c.enabled = c.module ? $(`module-${c.module}`).checked : true
			c.value = set_configs.find(x => x.name === c.id)?.value || ''
			return c
		})

		await _('server_configs', configs)
	}

	export async function set_module_enabled(module_id, enabled)
	{
		const res = await api(`
		mutation ($module_id: String!, $enabled: Boolean!) {
			setModuleEnabled(module_id: $module_id, enabled: $enabled)
		}`, {
			module_id: module_id,
			enabled: enabled,
		})

		const is_enabled = res.includes(module_id)
		if (is_enabled === enabled)
		{
			const id = `icon-module-${module_id}`
			$.blink(id)
		}

		$(`module-${module_id}`).checked = is_enabled

		//Build configs list
		let cfg = api.get_json('/config/configs.json')
		const set_configs = await api('{getConfigs { name value } }')
		let configs = (await cfg).map(c => {
			c.enabled = c.module ? $(`module-${c.module}`).checked : true
			c.value = set_configs.find(x => x.name === c.id)?.value || ''
			return c
		})
		await _('server_configs', configs)

		reset_modules(res)
	}

	export async function set_config(config_id)
	{
		const value = $.val(`config-${config_id}`) || null
		const res = api(`mutation ($name: String!, $value: String) {
			setConfig (name: $name, value: $value)
		}`, {
			name: config_id,
			value: value,
		})

		if (res)
		{
			$.blink(`icon-config-${config_id}`)
		}
		else
		{
			_.modal({
				type: 'error',
				title: 'ERROR',
				text: 'Failed to set config value for "'+config_id+'".',
				buttons: ['OK'],
			}).catch(() => {})
		}
	}
</script>